<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Checkout | Car Rental</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/assets/index.css}">
</head>
<body>

<div class="container checkout-container">
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
  <h2 class="mb-4 text-center">Xác Nhận Đặt Xe</h2>
  <div class="row">
    <!-- Left Side: Customer Info -->
    <div class="col-md-7">
      <h5 class="section-title">Thông Tin Khách Hàng</h5>
      <form action="/checkout/save" method="post">
        <div class="mb-3">
          <label class="form-label">Họ và tên</label>
          <input type="text" name="customer" class="form-control" placeholder="Nhập họ tên"
                 th:value="${account != null} ? ${account.getFullName()} : ''" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control" placeholder="Địa chỉ Gmail"
                 th:value="${account != null} ? ${account.getEmail()} : ''" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Số điện thoại</label>
          <input type="tel" name="phone" class="form-control" placeholder="Số điện thoại"
                 th:value="${account != null} ? ${account.getPhone()} : ''" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Địa điểm nhận xe</label>
          <input type="text" name="picklocation" class="form-control" placeholder="Nhập địa điểm"
                 th:value="${account != null} ? ${account.getAddress()} : ''" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Ghi chú</label>
          <textarea name="note" class="form-control" rows="3" placeholder="Ghi chú thêm..."></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Phương thức thanh toán</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="paymentmethod" id="paymentCash" value="CASH" checked>
              <label class="form-check-label" for="paymentCash">Tiền mặt</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="paymentmethod" id="paymentWallet" value="WALLET">
              <label class="form-check-label" for="paymentWallet">Ví điện tử</label>
            </div>
          </div>
        </div>

        <select class="form-select mb-3" id="discountSelect">
          <option value="0" data-percent="0" selected>Không áp dụng</option>
          <option th:each="p : ${promotionList}"
                  th:value="${p.getId()}"
                  th:attr="data-percent=${p.getDiscountpercent()}"
                  th:text="'Giảm ' + ${p.getDiscountpercent()} + '% - ' + ${p.description}">
          </option>
        </select>

        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="termsCheck" required>
          <label class="form-check-label" for="termsCheck">Tôi đồng ý với Chính sách và Điều khoản dịch vụ</label>
        </div>

        <input type="hidden" name="name" th:value="${car.getName()}"/>
        <input type="hidden" name="service" th:value="${service != null ? service.getNameService() : 'Không'}"/>
        <input type="hidden" name="receiveDate" th:value="${#dates.format(startDate, 'yyyy-MM-dd')}" />
        <input type="hidden" name="returnDate" th:value="${#dates.format(endDate, 'yyyy-MM-dd')}" />
        <input type="hidden" name="countDate" th:value="${countdate}"/>
        <input type="hidden" id="finalTotal" name="total" th:value="${total}"/>
        <input type="hidden" id="discountValue" name="discount" value="0"/>
        <input type="hidden" name="carid" th:value="${car.getId()}"/>
        <input type="hidden" name="price" th:value="${car.getPrice()}">
        <input type="hidden" name="serviceid" th:value="${service != null ? service.getId() : 0}"/>
        <input type="hidden" name="serviceprice" th:value="${service != null ? service.getPrice() : 0}"/>

        <button type="submit" class="btn btn-primary w-100 mt-3">Đặt xe</button>

      </form>
    </div>

    <!-- Right Side: Summary -->
    <div class="col-md-5">
      <h5 class="section-title">Tóm Tắt Đặt Xe</h5>
      <div class="summary-box">
        <img id="summaryImage" th:src="${car.image}" class="mb-3" alt="Ảnh xe">
        <h4 id="summaryCarName" th:text="${car.getName()}">Toyota Land Cruiser (2022)</h4>
        <p><strong>Dịch vụ:</strong>
          <span id="summaryService"
                th:text="${service != null ? service.getNameService() : ''}">Airport Transfer</span>
        </p>
        <p><strong>Ngày nhận:</strong>
          <span id="summaryDate" th:text="${#dates.format(startDate, 'dd/MM/yyyy')}">12/06/2025</span>
        </p>
        <p><strong>Ngày trả:</strong>
          <span id="summaryPeriod" th:text="${#dates.format(endDate, 'dd/MM/yyyy')}">14/06/2025</span>
        </p>

        <p><strong>Số ngày thuê:</strong>
          <span id="summaryDays" th:text="${countdate}">2 ngày</span>
        </p>
        <hr>
        <h5 class="text-primary">Tổng tiền: <span id="totalAmount" th:text="${total}">1000000</span></h5>

      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  let originalTotal = /*[[${total}]]*/ 0;
  /*]]>*/
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const discountSelect = document.getElementById("discountSelect");
    const discountInput = document.getElementById("discountValue");
    const totalAmountEl = document.getElementById("totalAmount");

    if (!discountSelect || !totalAmountEl || !discountInput) {
      console.error("Không tìm thấy phần tử cần thiết.");
      return;
    }

    discountSelect.addEventListener("change", function () {
      const selectedOption = discountSelect.options[discountSelect.selectedIndex];
      const discountPercent = parseFloat(selectedOption.getAttribute("data-percent")) || 0;

      const discountedTotal = originalTotal - (originalTotal * discountPercent / 100);
      totalAmountEl.textContent = discountedTotal;

      // Gán discount vào input hidden để gửi về server
      discountInput.value = discountPercent;
    });
  });
</script>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
